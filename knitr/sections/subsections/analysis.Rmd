<!--- Runs all analyses, saving results as an R object for loading --->
<!--- Summary --->
```{r load_data, echo = FALSE, cache = FALSE, results = 'asis', eval = TRUE}
load('d:/Rpackages/rclosed/data/ed attendances by mode measure - lsoa - 2016-05-18 15.05.Rda')
load('d:/Rpackages/rclosed/data/ed attendances by mode measure - site - 2016-05-18 15.06.Rda')
load('d:/Rpackages/rclosed/data/unnecessary ed attendances measure - lsoa - 2016-05-18 15.11.Rda')
load('d:/Rpackages/rclosed/data/unnecessary ed attendances measure - site - 2016-05-18 15.11.Rda')
load('d:/Rpackages/rclosed/data/ed attendances admitted measure - lsoa - 2016-05-18 15.01.Rda')
load('d:/Rpackages/rclosed/data/ed attendances admitted measure - site - 2016-05-18 15.01.Rda')
load('d:/Rpackages/rclosed/data/emergency admissions measure - lsoa - 2016-05-18 16.05.Rda')
load('d:/Rpackages/rclosed/data/emergency admissions measure - site - 2016-05-18 16.06.Rda')
load('d:/Rpackages/rclosed/data/critical care stays measure - lsoa - 2016-05-18 16.06.Rda')
load('d:/Rpackages/rclosed/data/critical care stays measure - site - 2016-05-18 16.07.Rda')
load('d:/Rpackages/rclosed/data/length of stay measure - lsoa - 2016-05-18 16.08.Rda')
load('d:/Rpackages/rclosed/data/length of stay measure - site - 2016-05-18 16.08.Rda')
```
```{r define_models, echo = FALSE, cache = FALSE, results = 'hide', eval = TRUE}
mod1 <- c('closure', 'season', 'relative.month', 'nhs111', 'other.centre', 'ambulance.divert')
mod2 <- c('town * closure', 'season', 'relative.month', 'nhs111', 'other.centre', 'ambulance.divert')
mod3 <- c('town * closure', 'season', 'relative.month', 'nhs111', 'other.centre', 'ambulance.divert')
mod4 <- c('town * closure', 'season', 'relative.month', 'nhs111', 'other.centre', 'ambulance.divert')
mod5 <- c('town * closure', 'season', 'relative.month', 'nhs111', 'other.centre', 'ambulance.divert')
mod6 <- c('town * closure', 'season', 'relative.month', 'nhs111', 'other.centre', 'ambulance.divert', 'diff.time.to.ed')
mod7 <- c('town * closure', 'season', 'relative.month', 'nhs111', 'other.centre', 'ambulance.divert', 'diff.time.to.ed')
```
```{r summary_analysis, echo = FALSE, cache = FALSE, results = 'asis', eval = FALSE}
diff.time.to.ed <- closed_summary(df          = ed_attendances_by_mode_measure,
                             df.steps    = sites,
                             vars        = value,
                             digits      = 3,
                             latex       = FALSE,
                             html        = FALSE)
```
<!--- Mode of Arrival - Any --->
```{r mode_of_arrival_any, echo = FALSE, cache = FALSE, results = 'hide', eval = TRUE}
mode.of.arrival.any <- closed_models(df.lsoa         = ed_attendances_by_mode_measure,
                                     df.trust        = ed_attendances_by_mode_site_measure,
                                     indicator       = 'ed attendances',
                                     sub.indicator   = 'any',
                                     steps           = c('closure'),
                                     fit.with        = 'both',
                                     panel.lsoa      = 'lsoa',
                                     panel.trust     = 'town',
                                     timevar         = 'relative.month',
                                     outcome         = 'value',
                                     model1          = mod1,
                                     model2          = mod2,
                                     model3          = mod3,
                                     model4          = mod4,
                                     model5          = mod5,
                                     model6          = mod6,
				     model7          = NULL,
                                     ## model7          = mod7,
                                     autocorr        = 'ar1',
                                     panelcorrmethod = 'pcse',
                                     plot            = TRUE,
                                     common.y        = TRUE,
                                     theme           = theme_bw(),
                                     return.model    = FALSE)
```

<!--- Mode of Arrival - Other --->
```{r mode_of_arrival_other, echo = FALSE, cache = FALSE, results = 'hide', eval = TRUE}
mode.of.arrival.other <- closed_models(df.lsoa         = ed_attendances_by_mode_measure,
                                     df.trust        = ed_attendances_by_mode_site_measure,
                                     indicator       = 'ed attendances',
                                     sub.indicator   = 'other',
                                     steps           = c('closure'),
                                     fit.with        = 'both',
                                     panel.lsoa      = 'lsoa',
                                     panel.trust     = 'town',
                                     timevar         = 'relative.month',
                                     outcome         = 'value',
                                     model1          = mod1,
                                     model2          = mod2,
                                     model3          = mod3,
                                     model4          = mod4,
                                     model5          = mod5,
                                     model6          = mod6,
				     model7          = NULL,
                                     ## model7          = mod7,
                                     autocorr        = 'ar1',
                                     panelcorrmethod = 'pcse',
                                     plot            = TRUE,
                                     common.y        = TRUE,
                                     theme           = theme_bw(),
                                     return.model    = FALSE)
```

<!--- Mode of Arrival - Ambulance --->
```{r mode_of_arrival_ambulance, echo = FALSE, cache = FALSE, results = 'hide', eval = TRUE}
mode.of.arrival.ambulance <- closed_models(df.lsoa         = ed_attendances_by_mode_measure,
                                     df.trust        = ed_attendances_by_mode_site_measure,
                                     indicator       = 'ed attendances',
                                     sub.indicator   = 'ambulance',
                                     steps           = c('closure'),
                                     fit.with        = 'both',
                                     panel.lsoa      = 'lsoa',
                                     panel.trust     = 'town',
                                     timevar         = 'relative.month',
                                     outcome         = 'value',
                                     model1          = mod1,
                                     model2          = mod2,
                                     model3          = mod3,
                                     model4          = mod4,
                                     model5          = mod5,
                                     model6          = mod6,
				     model7          = NULL,
                                     ## model7          = mod7,
                                     autocorr        = 'ar1',
                                     panelcorrmethod = 'pcse',
                                     plot            = TRUE,
                                     common.y        = TRUE,
                                     theme           = theme_bw(),
                                     return.model    = FALSE)
```

<!--- Unnecessary Attendance - NA --->
```{r unnecessary_ed_attendances, echo = FALSE, cache = FALSE, results = 'hide', eval = FALSE}
unnecessary_attendance <- closed_models(df.lsoa         = unnecessary_ed_attendances_measure,
                                     df.trust        = unnecessary_ed_attendances_site_measure,
                                     indicator       = 'unnecessary ed attendances',
                                     sub.indicator   = NA,
                                     steps           = c('closure'),
                                     fit.with        = 'both',
                                     panel.lsoa      = 'lsoa',
                                     panel.trust     = 'town',
                                     timevar         = 'relative.month',
                                     outcome         = 'value',
                                     model1          = mod1,
                                     model2          = mod2,
                                     model3          = mod3,
                                     model4          = mod4,
                                     model5          = mod5,
                                     model6          = mod6,
                                     ## model7          = mod7,
                                     autocorr        = 'ar1',
                                     panelcorrmethod = 'pcse',
                                     plot            = TRUE,
                                     common.y        = TRUE,
                                     theme           = theme_bw(),
                                     return.model    = FALSE)
```

<!--- ED Attendances Admitted - All --->
```{r ed_attendances_admitted_all, echo = FALSE, cache = FALSE, results = 'hide', eval = TRUE}
ed.attendances.admitted.all <- closed_models(df.lsoa         = ed_attendances_admitted_measure,
                                     df.trust        = ed_attendances_admitted_site_measure,
                                     indicator       = 'ed attendances admitted',
                                     sub.indicator   = 'all',
                                     steps           = c('closure'),
                                     fit.with        = 'both',
                                     panel.lsoa      = 'lsoa',
                                     panel.trust     = 'town',
                                     timevar         = 'relative.month',
                                     outcome         = 'value',
                                     model1          = mod1,
                                     model2          = mod2,
                                     model3          = mod3,
                                     model4          = mod4,
                                     model5          = mod5,
                                     model6          = mod6,
				     model7          = NULL,
                                     ## model7          = mod7,
                                     autocorr        = 'ar1',
                                     panelcorrmethod = 'pcse',
                                     plot            = TRUE,
                                     common.y        = TRUE,
                                     theme           = theme_bw(),
                                     return.model    = FALSE)
```

<!--- ED Attendances Admitted - Fraction Admitted --->
```{r ed_attendances_admitted_fraction_admitted, echo = FALSE, cache = FALSE, results = 'hide', eval = TRUE}
ed.attendances.admitted.fraction.admitted <- closed_models(df.lsoa         = ed_attendances_admitted_measure,
                                     df.trust        = ed_attendances_admitted_site_measure,
                                     indicator       = 'ed attendances admitted',
                                     sub.indicator   = 'fraction admitted',
                                     steps           = c('closure'),
                                     fit.with        = 'both',
                                     panel.lsoa      = 'lsoa',
                                     panel.trust     = 'town',
                                     timevar         = 'relative.month',
                                     outcome         = 'value',
                                     model1          = mod1,
                                     model2          = mod2,
                                     model3          = mod3,
                                     model4          = mod4,
                                     model5          = mod5,
                                     model6          = mod6,
				     model7          = NULL,
                                     ## model7          = mod7,
                                     autocorr        = 'ar1',
                                     panelcorrmethod = 'pcse',
                                     plot            = TRUE,
                                     common.y        = TRUE,
                                     theme           = theme_bw(),
                                     return.model    = FALSE)
```

<!--- ED Attendances Admitted - Admitted --->
```{r ed_attendances_admitted_admitted, echo = FALSE, cache = FALSE, results = 'hide', eval = TRUE}
ed.attendances.admitted.admitted <- closed_models(df.lsoa         = ed_attendances_admitted_measure,
                                     df.trust        = ed_attendances_admitted_site_measure,
                                     indicator       = 'ed attendances admitted',
                                     sub.indicator   = 'admitted',
                                     steps           = c('closure'),
                                     fit.with        = 'both',
                                     panel.lsoa      = 'lsoa',
                                     panel.trust     = 'town',
                                     timevar         = 'relative.month',
                                     outcome         = 'value',
                                     model1          = mod1,
                                     model2          = mod2,
                                     model3          = mod3,
                                     model4          = mod4,
                                     model5          = mod5,
                                     model6          = mod6,
				     model7          = NULL,
                                     ## model7          = mod7,
                                     autocorr        = 'ar1',
                                     panelcorrmethod = 'pcse',
                                     plot            = TRUE,
                                     common.y        = TRUE,
                                     theme           = theme_bw(),
                                     return.model    = FALSE)
```

<!--- Save all objects --->
```{r save_results, echo = FALSE, cache = FALSE, results = 'hide', eval = FALSE}
## save(diff.time.to.ed,
##      file = '../lib/data/summary.RData')
## save(mode.of.arrival.any,
##      mode.of.arrival.ambulance,
##      mode.of.arrival.other,
##      file # '../lib/data/results.mode.of.arrival.RData')
```